<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Sprachsynthese</title>
  <script src="../js/jquery/jquery.min.js" type="text/javascript"></script>
  <link rel="stylesheet" href="../css/yaio/main.css">
  <link rel="stylesheet" href="../css/yaio/style.css">

<style>

.hidden {
    display: none;
}

#info {

    font-size: 16px;
}

#results {
    font-size: 14px;
    font-weight: bold;
    border: 1px solid #ddd;
    padding: 15px;
    text-align: left;
    min-height: 150px;
}
.final {
    width: 100%;
    clear: both;
    color: black;
    padding-top: 3px;
}
.button {
    display: none;
}
input[type="number"] {
    width: 30px;
}
</style>
<style>
a.c1 {
    font-weight: normal;
}
</style>

</head>
<body>
    <div class="blockContent" id="blockContent">
        <div class="content" id="content">
            <div class="txt-content" id="txt-content">
                <div class="box">
                    <div id="info">
                    </div>
                    <div id="results">
                        <textarea class="final" id="final_textarea"
                            cols="30" rows="5"></textarea>
                    </div>

                      <label for="voice">Voice:</label>
                      <select id="voice"> </select>
                      <label class="hidden" for="rate">Rate (0.1 - 10):</label>
                      <input class="hidden" type="number" id="rate" min="0.1" max="10" value="1" step="0.1" />
                      <label class="hidden" for="pitch">Pitch (0.1 - 2):</label>
                      <input class="hidden" type="number" id="pitch" min="0.1" max="2" value="1" step="0.1" />
                      <br />
                      <button id="button-speak-ss" class="" onclick="startSpeech()">Start</button>
                      <button id="button-pause-ss" class="" onclick="pauseSpeech()">Pause</button>
                      <button id="button-resume-ss" class="" onclick="resumeSpeech()">Fortfahren</button>
                      <button id="button-stop-ss" class="" onclick="stopSpeech();window.close()">Schliessen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // inspired by http://www.sitepoint.com/talking-web-pages-and-the-speech-synthesis-api/
    // init voice config
    var voices = document.getElementById('voice');
    var rate = document.getElementById('rate');
    var pitch = document.getElementById('pitch');
    // Workaround for a Chrome issue (#340160 - https://code.google.com/p/chromium/issues/detail?id=340160)
    var watch = setInterval(function() {
        // Load all voices available
        var voicesAvailable = speechSynthesis.getVoices();
        if (voicesAvailable.length !== 0) {
            for(var i = 0; i < voicesAvailable.length; i++) {
                var selected = "";
                if (voicesAvailable[i].lang == "de-DE") {
                    selected = " selected ";
                }
                voices.innerHTML += '<option value="' + voicesAvailable[i].lang + '"' +
                                    'data-voice-uri="' + voicesAvailable[i].voiceURI + '"' + selected + '>' +
                                    voicesAvailable[i].name +
                                    (voicesAvailable[i].default ? ' (default)' : '') + '</option>';
            }
          clearInterval(watch);
        }
    }, 1);
    
    // inspired by http://stackoverflow.com/questions/21947730/chrome-speech-synthesis-with-longer-texts
    var splitChars = "\n?!:;,.";
    var splitWords = [" und ", " oder ", " aber ", " dabei ", " bis ", " "];

    var sayit = function () {
        var msg = new SpeechSynthesisUtterance();
        var selectedVoice = voices.options[voices.selectedIndex];
        msg.voice = selectedVoice.getAttribute('data-voice-uri'); // Note: some voices don't support altering params
        msg.voiceURI = 'native';
        msg.lang = selectedVoice.value;
        msg.volume = 1; // 0 to 1
        msg.rate = rate.value; // 0.1 to 10
        msg.pitch = pitch.value; //0 to 2
        msg.onstart = function (event) {
            console.log("started:" + msg.text);
        };
        msg.onend = function(event) {
            console.log('Finished in ' + event.elapsedTime + ' seconds.');
        };
        msg.onerror = function(event) {
            console.log('Errored ' + event);
        }
        msg.onpause = function (event) {
            console.log('paused ' + event);
        }
        msg.onboundary = function (event) {
            console.log('onboundary ' + event);
        }

        return msg;
    }

    var speekResponse = function (text, splitterStr, ebene, maxLength) {
        // set default maxLength if not set
        if (! (maxLength > 100)) {
            maxLength = 100;
        }
        
        // split sentences
        var splitter = splitterStr.substr(ebene,1);
        var sentences = [];
        
        // if last splitChar rechaed, split by splitwords
        if (ebene >= splitterStr.length) {
            // split at last splitword before maxLength
            var nextText = "";
            var wordIndex = 0;
            
            // interate splitwords till text < maxLength
            do {
                var splitWord = splitWords[wordIndex];
                var pos = text.lastIndexOf(splitWord);
                while (pos > 0  && text.length > maxLength) {
                    // iterate until splitword found before maxLength
                    nextText = text.substr(pos) + nextText;
                    text = text.substr(0, pos);
                    pos = text.lastIndexOf(splitWord);
                    console.log("split by word:'" + splitWord + "' text:''" + text + "' nextText:'" + nextText + "'");
                }
                wordIndex++;
            } while (wordIndex < splitWords.length && text.length > maxLength)
            
            // fallback if text > maxLength
            if (text.length > maxLength) {
                // attempt to split a " " before maxLength
                var posSpace = text.indexOf(" ");
                if ((posSpace <= 0 || posSpace > maxLength)) {
                    // not " " before maxLength -> do it hard
                    var text1 = text.substr(0, maxLength);
                    var text2 = text.substr(maxLength);
                    console.log("split texthard text1:'" + text1 + "' text2:''" + text2 + "'");
                    sentences = [text1, text2];
                } else {
                    // split at space   
                    var text1 = text.substr(0, posSpace);
                    var text2 = text.substr(posSpace);
                    console.log("split space text1:'" + text1 + "' text2:''" + text2 + "'");
                    sentences = [text1, text2];
                }
            } else {
                // add text
                sentences.push(text);
            }
            
            // add nextText
            sentences.push(nextText);
        } else {
            // plsit text by splitter
            console.log("split by:'" + splitter + "' ebene:" + ebene);
            sentences = text.split(splitter);
        }
        
        // iterate sentences
        for (var i=0;i< sentences.length;i++) {
            if (sentences[i].length > maxLength) {
                // sentence  > maxLength: split it with next splitChar
                console.log("split new " +  i + " sentences[i]:" + sentences[i])
                speekResponse(sentences[i], splitterStr, ebene+1);
            } else {
                // sentence ok: say it
                console.log("say i: " + i + " sentences[i]:" + sentences[i])
                var toSay = sayit();
                toSay.text = sentences[i] + splitter;
                window.speechSynthesis.speak(toSay);
            }
        }
    }

    function getSrcFromOpener() {
        // Text vom Opener holen
        if (opener && opener.targetElement) {
            final_textarea.value = $(opener.targetElement).text();
            if (! final_textarea.value) {
                final_textarea.value = $(opener.targetElement).val();
            }
        }
    }
    
    function startSpeech() {
        stopSpeech();
        document.getElementById('button-pause-ss').removeAttribute('disabled');
        document.getElementById('button-resume-ss').setAttribute('disabled', 'disabled');
        speekResponse(final_textarea.value, splitChars, 0, 150);
    }
    function stopSpeech() {
        for (var i=1; i < 100; i++) {
            window.speechSynthesis.cancel(); // if it errors, this clears out the error.
        }
    }
    function pauseSpeech() {
        window.speechSynthesis.pause();
        document.getElementById('button-pause-ss').setAttribute('disabled', 'disabled');
        document.getElementById('button-resume-ss').removeAttribute('disabled');
    }
    function resumeSpeech() {
        window.speechSynthesis.resume();
        document.getElementById('button-pause-ss').removeAttribute('disabled');
        document.getElementById('button-resume-ss').setAttribute('disabled', 'disabled');
    }


    window.onbeforeunload = function (e) {
        stopSpeech();
    };

    // init
    document.getElementById('button-pause-ss').setAttribute('disabled', 'disabled');
    document.getElementById('button-resume-ss').setAttribute('disabled', 'disabled');
    getSrcFromOpener();
</script>
</body>
</html>